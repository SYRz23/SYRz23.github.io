<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kahoot Quiz</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
    <h2 id="logintitle" style="display: block;">Login</h2>
    <form id="login" style="display: block;">
        <input type="text" id="username" placeholder="Username"><br>
        <input type="password" id="password" placeholder="Password"><br>
        <button type="submit">Login</button>
    </form>
    <h1 id="quizTitle" style="display: none;">Kahoot Quiz Information</h1>

    <!-- Kahoot Quiz Section -->
    <div id="quizSection" style="display: none;">
        <label for="kahootId">Input Kahoot ID:</label>
        <input type="text" id="kahootId" placeholder="Enter Kahoot ID">
        <button onclick="submitKahootId()">Submit</button>

        <div id="quizInfo"></div>
    </div>

    <h2 id="KBTitle" style="display: none;">Kahoot Quiz Bot</h2>
    <div id="KBSection" style="display: none;">
        <label for="kahootpin">Input Kahoot PIN and Username (for bot):</label>
        <input type="text" id="kahootpin" placeholder="Enter Kahoot PIN">
        <input type="text" id="kahootuser" placeholder="Enter Kahoot Username">
        <input type="text" id="kahootbots" placeholder="Enter Amount Of Kahoot Bots">
        <button type="button" onclick="submitKahootBotRequest()">Submit</button>
        
        <div id="responseMessage"></div>
    </div>

    <script>
        // Password Check (Compare with Vercels env secret database)
        document.getElementById('login').onsubmit = function(logincheck) {
            logincheck.preventDefault();
            var username = CryptoJS.SHA256(document.getElementById('username').value).toString();
            var password = CryptoJS.SHA256(document.getElementById('password').value).toString();

            const correctuser_hash256 = "8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918"
            const correctpw_hash256 = "240be518fabd2724ddb6f04eeb1da5967448d7e831c08c8fa822809f74c720a9"
            if(username === correctuser_hash256 && password == correctpw_hash256) {
                alert('Login successful!');
                document.getElementById('quizSection').style.display = "block";
                document.getElementById('quizTitle').style.display = "block";
                document.getElementById('KBTitle').style.display = "block";
                document.getElementById('KBSection').style.display = "block";
                document.getElementById('login').style.display = "none";
                document.getElementById('logintitle').style.display = "none";
            } else {
                alert('Please enter both username and password');
            }
        };
        
        // Kahoot quiz submission
        async function submitKahootId() {
            const kahootId = document.getElementById("kahootId").value;
            if (kahootId) {
                GetAnswers(kahootId);
            } else {
                alert("Please enter a valid Kahoot ID!");
            }
        }

        async function submitKahootBotRequest() {
            const kahootpin = document.getElementById("kahootpin").value;
            const kahootuser = document.getElementById("kahootuser").value;
            const kahootbots = document.getElementById("kahootbots").value;

            try {
                const response = await fetch('/api/kahootbot', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ kahootpin, kahootuser }),
                });

                const data = await response.json();

                // Display success or error message
                const messageDiv = document.getElementById('responseMessage');
                if (data.success) {
                    messageDiv.textContent = `Successfully joined game as ${kahootuser}!`;
                    messageDiv.style.color = 'green';
                } else {
                    messageDiv.textContent = `Error: ${data.message}`;
                    messageDiv.style.color = 'red';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('responseMessage').textContent = 'There was an error connecting to the server.';
            }
        
        // Fetch Kahoot answers
        async function GetAnswers(KahootID) {
            const proxy = "https://api.allorigins.win/get?url="; 
            const base_url = "https://create.kahoot.it/rest/kahoots/";
            const request_url = proxy + encodeURIComponent(base_url + KahootID); 
            
            axios.get(request_url)
                .then(response => {
                    const fent = JSON.parse(response.data.contents);  
                    processQuizData(fent); 
                })
                .catch(error => {
                    console.error("Error:", error); 
                    alert("Failed to fetch quiz data. Please check the Kahoot ID.");
                });
        }

        // Process and display quiz data
        function processQuizData(fent) {
            const quizInfoDiv = document.getElementById("quizInfo");
            quizInfoDiv.innerHTML = '';

            // Display questions and answers
            fent['questions'].forEach((question, i) => {
                if (question) {
                    quizInfoDiv.innerHTML += `<h3>Question ${i + 1} Type: ${question['type']}</h3>`;
                    
                    if (question['question']) {
                        quizInfoDiv.innerHTML += `<p><strong>Question:</strong> ${question['question']}</p>`;
                        
                        if (question['choices']) {
                            question['choices'].forEach((choice, j) => {
                                if (choice['correct'] === true) {
                                    if (choice['answer'].includes("True") || choice['answer'].includes("False")) {
                                        quizInfoDiv.innerHTML += `<p>Answer: ${choice['answer']} (Color: ${["Blue", "Red"][j]})</p>`;
                                    } else {
                                        quizInfoDiv.innerHTML += `<p>Answer: ${choice['answer']} (Color: ${["Red", "Blue", "Yellow", "Green"][j]})</p>`;
                                    }
                                }
                            });
                        }
                    }
                }
            });
        }
    </script>

</body>
</html>
